{% extends 'base.html' %}
{% load i18n %}
{% block title %} {% trans 'Dashboard' %} | {% trans 'Youth Road Analyzer' %} {% endblock title %}
{% load static %}

{% block header %}
{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans 'Dashboard' %}</li>
    </ol>
</nav>

{% include 'snippets/messages.html' %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="title-1">{% trans 'Dashboard' %}</h1>
    <div class="dropdown">
        <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="fas fa-cog"></i>
        </button>
        <div class="dropdown-menu">
            <h6 class="dropdown-header">{% trans 'Dashboard settings' %}</h6>
            <button class="dropdown-item active" type="button">{% trans 'Display grid' %}</button>
            <button class="dropdown-item" type="button">{% trans 'Display table' %}</button>
            <hr>
            <button class="dropdown-item" type="button">{% trans 'Manage dashboard' %}</button>
        </div>
    </div>
</div>

<div class="row users-count px-3">
    <div class="col-6 col-md-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-aqua"></i></h3>
            <div class="text-right">
                {% trans 'Students' %}
                <h2>{{ student_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-orange"></i></h3>
            <div class="text-right">
                {% trans 'Students Tested' %}
                <h2>{{ lecturer_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-red"></i></h3>
            <div class="text-right">
                {% trans 'Administrators' %}
                <h2>{{ superuser_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 mb-3 px-2">
        <div class="card-count p-3">
            <h3><i class="fas fa-users bg-light-purple"></i></h3>
            <div class="text-right">
                {% trans 'Programs' %}
                <h2>{{ total_program_count }}</h2> 
            </div>
        </div>
    </div>
</div>

<!--
    REMOVE the "traffic" and "enrollment" chart columns entirely.
    We also rename the "students_grade" canvas to "students_age".
-->

<div class="row px-2">
    <!-- Just keep one chart for Students Age (replacing "students_grade"). -->
    <div class="col-md-6 p-2">
        
        <div class="chart-wrap">
            <i class="fas fa-expand-alt"></i>
            <canvas id="students_age"></canvas>
        </div>
    </div>
    
    <!-- Keep the activities card on the right -->
    <div class="col-md-6 p-2">
        <div class="card w-100 h-100 p-3">
            <h5>{% trans 'Latest activities' %}</h5>
            <ul class="ps-2 small">
                {% for log in logs %}
                <li>{{ log.message }} <span class="text-muted">- {{ log.created_at }}</span></li>
                {% empty %}
                <li>{% trans 'No recent activity' %}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<br>

<div class="bg-white p-3">
    <h5 class="border-bottom pb-2">{% trans 'Acadmy Demographics' %}</h5>
    <div class="row">
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <!-- Students Gender Pie -->
            <canvas id="gender"></canvas>
        </div>
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <!-- Student Levels Pie -->
            <canvas id="student_levels_chart"></canvas>
        </div>
        <div class="col-md-4">
            <i class="fas fa-expand-alt"></i>
            <!-- Student Colleges Pie (Legend Callback) -->
            <canvas id="student_colleges_chart"></canvas>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}

<script src="{% url 'javascript-catalog' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>

<script>
    $('.fa-expand-alt').click(function () {
        if ($(this).parent('.chart-wrap').parent('.col-md-6').hasClass('expand')) {
            $('.col-md-6.expand').removeClass('expand');
        } else {
            $('.col-md-6.expand')?.removeClass('expand');
            $(this).parent('.chart-wrap').parent('.col-md-6').addClass('expand');
        }
    })
</script>

<script>
    // From your view, we assume these context variables are passed in:
    const malesCount = {{ males_count }};      // e.g. 20
    const femalesCount = {{ females_count }};  // e.g. 30

    // For the demographic pies
    const studentLevelsData = {{ student_levels|safe }};   // { "Bachelor Degree": X, "Master Degree": Y, ... }
    const studentCollegesData = {{ student_colleges|safe }};  // { "Faculty of Eng.": A, "Faculty of Medicine": B, ... }

    // For the new "Students Age" bar chart:
    // e.g. { "18": 5, "19": 10, "20": 8, "21": 12 }
    const studentAgesData = {{ student_ages|safe }};

$(document).ready(function () {

    // ---------------------------------------------------------
    // 1) Students Age (Bar)
    // ---------------------------------------------------------
    const studentAgesLabels = Object.keys(studentAgesData);       // e.g. [ "18", "19", "20", "21" ]
    const studentAgesValues = Object.values(studentAgesData);     // e.g. [ 5, 10, 8, 12 ]

    const dataStudentAges = {
      labels: studentAgesLabels,
      datasets: [{
        label: gettext("Number of Students by Age"),
        backgroundColor: 'rgba(86, 224, 224, 0.5)',
        borderColor: 'rgb(86, 224, 224)',
        hoverBorderWidth: 3,
        data: studentAgesValues
      }]
    };

    var students_age = document.getElementById('students_age');
    new Chart(students_age, {
      type: 'bar',
      data: dataStudentAges,
      options: {
        plugins: {
          title: {
            display: true,
            text: gettext('Students Age Distribution'),
            padding: 20
          },
          legend: {
            display: false  // optional if you don't want a legend
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: gettext('Number of Students')
            }
          },
          x: {
            title: {
              display: true,
              text: gettext('Age')
            }
          }
        }
      }
    });

    // ---------------------------------------------------------
    // 2) Students Gender Pie
    // ---------------------------------------------------------
    const dataGender = {
        labels: [
            gettext('Man'),
            gettext('Women')
        ],
        datasets: [{
            label: gettext("Students Gender Dataset"),
            data: [malesCount, femalesCount],
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)'
            ],
            hoverOffset: 4
        }]
    };

    var gender = document.getElementById('gender');
    new Chart(gender, {
        type: 'pie',
        data: dataGender,
        options: {
            plugins: {
                title: {
                    display: true,
                    text: gettext('Students Gender'),
                    padding: 20
                }
            }
        }
    });

    // ---------------------------------------------------------
    // 3) Students Levels Pie
    // ---------------------------------------------------------
    const studentLevelsLabels = Object.keys(studentLevelsData);
    const studentLevelsValues = Object.values(studentLevelsData);

    const dataStudentLevels = {
      labels: studentLevelsLabels,
      datasets: [{
        label: gettext("Student Levels"),
        data: studentLevelsValues,
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(255, 193, 7)',
          'rgb(54, 162, 235)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)',
          'rgb(255, 159, 64)'
        ],
        hoverOffset: 4
      }]
    };

    var studentLevelsChart = document.getElementById('student_levels_chart');
    new Chart(studentLevelsChart, {
      type: 'pie',
      data: dataStudentLevels,
      options: {
        plugins: {
          title: {
            display: true,
            text: gettext('Student Levels'),
            padding: 20
          }
        }
      }
    });

    // ---------------------------------------------------------
    // 4) Students Colleges Pie (with legend callback)
    // ---------------------------------------------------------
    const studentCollegesLabels = Object.keys(studentCollegesData);
    const studentCollegesValues = Object.values(studentCollegesData);

    const dataStudentColleges = {
      labels: studentCollegesLabels,
      datasets: [{
        label: gettext("Student Colleges Dataset"),
        data: studentCollegesValues,
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(255, 193, 7)',
          'rgb(54, 162, 235)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)',
          'rgb(255, 159, 64)',
        ],
        hoverOffset: 4
      }]
    };

    var studentCollegesChart = document.getElementById('student_colleges_chart');
    new Chart(studentCollegesChart, {
      type: 'pie',
      data: dataStudentColleges,
      options: {
        plugins: {
          legend: {
            labels: {
              generateLabels: function (chart) {
                let defaultLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                // Sort them desc by slice value
                defaultLabels.sort((a, b) => b.value - a.value);
                // Keep top 3 only
                return defaultLabels.slice(0, 3);
              }
            }
          },
          title: {
            display: true,
            text: gettext('Student Colleges (Top 3 in Legend)'),
            padding: 20
          }
        }
      }
    });

});
</script>

{% endblock %}
