{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "Learning Methods" %} | {% trans "Youth Road Analyzer" %}{% endblock title %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
    }
    .select2-container--bootstrap-5 .select2-selection--single {
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding: 0;
        line-height: 1.5;
    }
    .select2-search.select2-search--dropdown .select2-search__field {
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        width: 100% !important;
    }
    .select2-container--bootstrap-5 .select2-dropdown {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .select2-container--bootstrap-5 .select2-search--dropdown {
        padding: 0.5rem;
    }
    .select2-results__option {
        padding: 0.375rem 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- BREADCRUMB -->
<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans 'Learning Methods' %}</li>
    </ol>
</nav>

<h1 class="title-1 mb-4">{% trans "Learning Methods" %}</h1>

<div class="row g-3 align-items-center mb-3">
    <!-- Form for both student and group selection -->
    <form method="get" action="" class="row g-3 align-items-center">
        <!-- Student Selection -->
        <div class="col-auto">
            <label for="student" class="col-form-label fw-bold">
                {% trans "Select Student" %}:
            </label>
        </div>
        <div class="col-auto position-relative">
            <select name="student" id="student" class="form-select select2-hidden-accessible" style="width: 300px;">
                <option></option>
                {% for st in students %}
                    <option value="{{ st.id }}" {% if selected_student and selected_student.id == st.id %}selected{% endif %}>
                        {{ st }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Group Count Selection -->
        <div class="col-auto">
            <label for="group_count" class="col-form-label fw-bold">
                {% trans "Learning Style Groups" %}:
            </label>
        </div>
        <div class="col-auto">
            <select name="group_count" id="group_count" class="form-select">
                <option value="4" {% if group_count == '4' %}selected{% endif %}>4 Groups (VARK)</option>
                <option value="3" {% if group_count == '3' %}selected{% endif %}>3 Groups (VA-RK-Special)</option>
                <option value="2" {% if group_count == '2' %}selected{% endif %}>2 Groups (VA-RK)</option>
            </select>
        </div>

        <!-- Submit Button -->
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> {% trans "View" %}
            </button>
        </div>
    </form>
</div>

{% if selected_student %}
    <!-- Selected Student info + buttons -->
    <div class="row g-3 align-items-center">
        <div class="col-auto">
            <h4 class="mb-0">
                {% trans "Selected Student" %}: 
                <span class="text-warning">{{ selected_student }}</span>
                , ID: <span class="text-warning">{{ student_id }}</span>
            </h4>
        </div>
        <div class="col-auto d-flex align-items-center">
            {% if latest_test %}
                <span class="text-info me-3 d-flex align-items-center">
                    <i class="fas fa-check-circle me-1"></i>
                    {% trans "Last test taken on" %}: {{ latest_test.date_taken|date:"F d, Y H:i" }}
                </span>
                <a href="{% url 'learning_methods:fill_test' selected_student.id %}" class="btn btn-primary me-2">
                    <i class="fas fa-redo-alt"></i> {% trans "Retake Test" %}
                </a>
                <a href="{% url 'learning_methods:results' selected_student.id %}?group_count={{ group_count }}" class="btn btn-success">
                    <i class="fas fa-chart-bar"></i> {% trans "View Results" %}
                </a>
            {% else %}
                <span class="text-warning me-3 d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    {% trans "This student has not taken the learning style test yet." %}
                </span>
                <a href="{% url 'learning_methods:fill_test' selected_student.id %}" class="btn btn-primary">
                    <i class="fas fa-play-circle"></i> {% trans "Take Test" %}
                </a>
            {% endif %}
        </div>
    </div>
{% endif %}

{% endblock content %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for student selection
        $('#student').select2({
            theme: 'bootstrap-5',
            placeholder: "{% trans 'Type to search for a student...' %}",
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            dropdownAutoWidth: true,
            selectOnClose: false,
            dropdownParent: $('#student').parent(),
            language: {
                noResults: function() {
                    return "{% trans 'No students found' %}";
                }
            }
        }).on('select2:open', function() {
            // Focus the search field when dropdown opens
            setTimeout(function() {
                $('.select2-container--open .select2-search__field').get(0).focus();
            }, 10);
        });
    });
</script>
{% endblock %}